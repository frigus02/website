<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="my-header.html">
<link rel="import" href="my-socials.html">
<link rel="import" href="my-footer.html">

<dom-module id="my-app">
    <template>
        <style>
            :host {
                --text-color: #000000;

                display: block;
                max-width: 500px;
                padding: 0 0.5em;
                margin: 0 auto;
                position: relative;
            }

            paper-progress {
                width: 100%;
                --paper-progress-active-color: #999;
            }
        </style>

        <app-location route="{{route}}"></app-location>
        <app-route
                route="{{route}}"
                pattern="[[routeRootPattern]]:page"
                data="{{routeData}}"
                tail="{{routeTail}}"></app-route>

        <my-header
                page-path="[[routeData.page]]"
                page-title="[[pageTitle]]"></my-header>
        <paper-progress indeterminate hidden$="[[!loading]]"></paper-progress>

        <iron-pages
                selected="[[page]]"
                attr-for-selected="name"
                fallback-selection="404"
                selected-attribute="active"
                role="main"
                on-page-title-changed="_viewPageTitleChanged"
                on-loading-changed="_viewLoadingChanged">
            <my-view-about name="about"></my-view-about>
            <my-view-posts name="posts" route="[[routeTail]]"></my-view-posts>
            <my-view-projects name="projects" route="[[routeTail]]"></my-view-projects>
            <my-view-impress name="impress"></my-view-impress>
            <my-view-404 name="404"></my-view-404>
        </iron-pages>

        <my-socials></my-socials>
        <my-footer></my-footer>
    </template>

    <script>
        class MyApp extends Polymer.Element {
            static get is() {
                return 'my-app';
            }

            static get properties() {
                return {
                    page: {
                        type: String,
                        observer: '_pageChanged'
                    },
                    pageTitle: {
                        type: String,
                        observer: '_pageTitleChanged'
                    },
                    routeRootPattern: String,
                    routeData: Object,
                    routeTail: String,
                    loading: {
                        type: Boolean,
                        value: true
                    },

                    // This shouldn't be neccessary, but the Analyzer isn't picking up
                    // Polymer.Element#rootPath
                    rootPath: String
                };
            }

            static get observers() {
                return [
                    '_routePageChanged(routeData.page)'
                ];
            }

            constructor() {
                super();

                // Get root pattern for app-route, for more info about `rootPath` see:
                // https://www.polymer-project.org/2.0/docs/upgrade#urls-in-templates
                this.routeRootPattern = new URL(this.rootPath).pathname;
            }

            _routePageChanged(page) {
                if (page === undefined) {
                    return;
                }

                this.page = page || 'about';
            }

            _pageChanged(page) {
                this.loading = true;
                this.pageTitle = '';

                const resolvedPageUrl = this.resolveUrl(`my-view-${page}.html`);
                Polymer.importHref(
                    resolvedPageUrl,
                    this._viewLoaded.bind(this),
                    this._showPage404.bind(this),
                    true);
            }

            _pageTitleChanged(pageTitle) {
                if (!this.routeData.page) {
                    document.title = 'Jan Kühle';
                } else {
                    document.title = `${pageTitle} - Jan Kühle`;
                }
            }

            _viewLoaded() {
                const view = this.shadowRoot.querySelector(`my-view-${this.page}`);
                if (view) {
                    this.loading = false;
                    this.pageTitle = view.pageTitle;
                }
            }

            _viewPageTitleChanged(event) {
                if (event.target.getAttribute('name') === this.page) {
                    this.pageTitle = event.detail.value;
                }
            }

            _viewLoadingChanged(event) {
                const view = event.composedPath().find(node => node.nodeName.startsWith('MY-VIEW-'));
                if (view.getAttribute('name') === this.page) {
                    this.loading = event.detail.value;
                }
            }

            _showPage404() {
                this.page = '404';
            }
        }

        window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>
